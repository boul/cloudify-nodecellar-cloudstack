tosca_definitions_version: cloudify_dsl_1_0

imports:
    - http://www.getcloudify.org/spec/bash-plugin/1.1/plugin.yaml
    - http://www.getcloudify.org/spec/cloudify/3.1/types.yaml
    #- http://www.getcloudify.org/spec/openstack-plugin/1.0/plugin.yaml

plugins:
    cloudstack:
        executor: central_deployment_agent
        source: https://github.com/boul/cloudify-cloudstack-plugin/archive/master.zip

    nodecellar_config_plugin:
        executor: host_agent
        source: nodecellar-config-plugin

    

node_types:
    cloudstack_network:
        derived_from: cloudify.types.network
        properties:
            auth:
                default:
                    API_KEY: 'key'
                    API_SECRET_KEY: 'key'
                    API_URL: 'https://cloud/client/api'
            network:
                default:
                    service_offering: 'SourceNatNiciraNvpNetwork'
                    zone: 'BETA-SBP-DC-1'
            rules:
                default: {}
            
        interfaces:
            cloudify.interfaces.lifecycle:
                - create: cloudstack.cloudstack_plugin.network.create
                - delete:cloudify.cloudstack_plugin.network.delete

    cloudstack_vm:
        derived_from: cloudify.types.host     
        properties:
            auth:
                default:
                    API_KEY: 'key'
                    API_SECRET_KEY: 'key'
                    API_URL: 'https://cloud/client/api'
            install_agent:
                default: true            
            cloudify_agent:
                default:
                    user: root
                    port: 22
                    # example for ssh key file (see `key_name` below) 
                    # this file matches the agent key configured during the bootstrap
                    key: /root/.ssh/cloudify-agents-kp.pem
            server:
                default:
                    ### if defined, will serve as the hostname for the started instance,
                    ### otherwise, the node_id will be used
                    #name: no_name            ### HOST_NAME""
                    image_id: 8e6cb1ed-9c9a-4e5b-88f4-407437fd5eee
                    size: employee-medium-ha
                    keypair_name: cloudify-agents-kp
                    networks: ['node_cellar_network']
                    ip_address: {}
        interfaces:
            cloudify.interfaces.lifecycle:
                -   delete:cloudify.cloudstack_plugin.virtual_machine_in_network.delete
                -   start:cloudify.cloudstack_plugin.virtual_machine_in_network.start
                -   stop:cloudify.cloudstack_plugin.virtual_machine_in_network.stop
            cloudify.interfaces.host:
                -   get_state:cloudify.cloudstack_plugin.virtual_machine_in_network.get_state

    mongo_database:
        derived_from: cloudify.types.bash.db_server
        properties:
            role: {}
            port: {}

    nodejs_server:
        derived_from: cloudify.types.bash.app_server

    nodejs_app:
        derived_from: cloudify.types.bash.app_module
        properties:
            app_name: {}
            startup_script: {}
            git_url: {}
            git_branch: {}
            base_port: {}
            num_instances: {}
            env_file_path:
                default: ''

relationships:
    nodecellar_connected_to_mongo:
        derived_from: cloudify.relationships.connected_to
        source_interfaces:
            cloudify.interfaces.relationship_lifecycle:
                - postconfigure: nodecellar_config_plugin.tasks.get_mongo_host_and_port


node_templates:
    node_cellar_network:
      type: cloudstack_network
      properties:
          network:
              name: node_cellar_network
              service_offering: 'SourceNatNiciraNvpNetwork'
              zone: 'BETA-SBP-DC-1'
          rules:
              - cidr: 0.0.0.0/0
                start_port: 8080
              - cidr: 0.0.0.0/0
                start_port: 27017
              - cidr: 0.0.0.0/0
                start_port: 28017

    mongod_vm:
        type: cloudstack_vm
        instances:
            deploy: 1
        relationships:
            - target: node_cellar_network
              type: cloudify.relationships.connected_to

    nodejs_vm:
        type: cloudstack_vm
        instances:
          deploy: 1
        relationships:
            - target: node_cellar_network
              type: cloudify.relationships.connected_to

    mongod:
        type: mongo_database
        properties:
            role: mongod
            port: 27017
            scripts:            
                create: mongo-scripts/install-mongo.sh
                start: mongo-scripts/start-mongo.sh
                stop: mongo-scripts/stop-mongo.sh
        relationships:
            - target: mongod_vm
              type: cloudify.relationships.contained_in

    nodejs:
        type: nodejs_server
        properties:
            scripts:            
                create: nodejs-scripts/install-nodejs.sh
        relationships:
            - type: cloudify.relationships.contained_in
              target: nodejs_vm

    nodecellar_app:
        type: nodejs_app
        properties:
            app_name: nodecellar
            startup_script: server.js
            git_url: https://github.com/cloudify-cosmo/nodecellar.git
            git_branch: master 
            base_port: 8080
            num_instances: 1
            scripts:            
                create: nodejs-scripts/install-app.sh
                start: nodejs-scripts/start-app.sh
                stop: nodejs-scripts/stop-app.sh
        relationships:
            - type: cloudify.relationships.contained_in
              target: nodejs
            - type: nodecellar_connected_to_mongo 
              target: mongod
        

